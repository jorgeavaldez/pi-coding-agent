#+title: pi-coding-agent
#+author: Daniel Nouri

#+html: <a href="https://melpa.org/#/pi-coding-agent"><img alt="MELPA" src="https://melpa.org/packages/pi-coding-agent-badge.svg"/></a>
#+html: <a href="https://github.com/dnouri/pi-coding-agent/actions/workflows/test-unit.yml"><img alt="Unit Tests" src="https://github.com/dnouri/pi-coding-agent/actions/workflows/test-unit.yml/badge.svg"/></a>
#+html: <a href="https://github.com/dnouri/pi-coding-agent/actions/workflows/test-integration.yml"><img alt="Integration Tests" src="https://github.com/dnouri/pi-coding-agent/actions/workflows/test-integration.yml/badge.svg"/></a>
#+html: <a href="https://github.com/dnouri/pi-coding-agent/actions/workflows/test-gui.yml"><img alt="GUI Tests" src="https://github.com/dnouri/pi-coding-agent/actions/workflows/test-gui.yml/badge.svg"/></a>
#+html: <a href="https://github.com/dnouri/pi-coding-agent/actions/workflows/nightly.yml"><img alt="Nightly" src="https://github.com/dnouri/pi-coding-agent/actions/workflows/nightly.yml/badge.svg"/></a>

An Emacs frontend for the [[https://shittycodingagent.ai/][pi coding agent]].

[[https://danielnouri.org/media/pi-el-demo.gif]]

* Features

- Separate windows for chat history and prompt composition
- Native markdown rendering with syntax highlighting
- Auto-scroll that preserves your position when reading earlier content
- Collapsible tool output with preview
- Input history with search
- Magit-style transient menu for all commands
- Full support for pi features: models, thinking levels, sessions, custom commands

* Requirements

- Emacs 28.1 or later
- [[https://shittycodingagent.ai/][pi coding agent]] installed and in PATH

** Installing pi coding agent

#+begin_src bash
# Install with npm
npm install -g @mariozechner/pi-coding-agent

# Or with mise
mise use -g npm:@mariozechner/pi-coding-agent
#+end_src

* Installation

** MELPA

Once available on [[https://melpa.org/#/pi-coding-agent][MELPA]], you can install directly:

#+begin_src
M-x package-install RET pi-coding-agent RET
#+end_src

Or with =use-package=:

#+begin_src emacs-lisp
(use-package pi-coding-agent
  :ensure t
  :init (defalias 'pi 'pi-coding-agent))
#+end_src

If you don't have MELPA configured, add this to your init file:

#+begin_src emacs-lisp
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(package-initialize)
#+end_src

** Manual installation

Clone the repository and add to your load path:

#+begin_src bash
git clone https://github.com/dnouri/pi-coding-agent ~/.emacs.d/site-lisp/pi-coding-agent
#+end_src

#+begin_src emacs-lisp
(add-to-list 'load-path "~/.emacs.d/site-lisp/pi-coding-agent")
(require 'pi-coding-agent)
#+end_src

Or with =use-package=:

#+begin_src emacs-lisp
(use-package pi-coding-agent
  :load-path "~/.emacs.d/site-lisp/pi-coding-agent"
  :init (defalias 'pi 'pi-coding-agent))
#+end_src

* Usage

Start a session with =M-x pi=. This opens two windows:
- *Chat buffer* (top): Shows conversation history with rendered markdown
- *Input buffer* (bottom): Where you compose prompts

Type your prompt and press =C-c C-c= to send. Press =C-c C-p= for the full command menu.

For multiple sessions in the same directory, use =C-u M-x pi= to create a named session.

* Key Bindings

| Key           | Context | Description        |
|---------------+---------+--------------------|
| =C-c C-c=     | input   | Send prompt        |
| =C-c C-k=     | input   | Abort streaming    |
| =C-c C-p=     | both    | Open menu          |
| =C-c C-r=     | input   | Resume session     |
| =M-p= / =M-n= | input   | History navigation |
| =C-r=         | input   | Search history     |
| =n= / =p=     | chat    | Navigate messages  |
| =TAB=         | chat    | Toggle tool output |

Press =C-c C-p= to access the full menu with model selection, thinking level,
session management (new, resume, branch, export), statistics, and custom commands.

* Tips & Tricks

** üìÅ Folding Turns

Press =TAB= on a turn header (You/Assistant) to fold it, =TAB= again to
unfold. Use =S-TAB= to cycle visibility of all turns at once.

** ‚úèÔ∏è Composing Prompts

The input buffer is a full Emacs buffer‚Äîone of the main advantages over
terminal interfaces. Write multi-line prompts, yank code from other
buffers with =C-y=, or use any editing commands you know.

Slash commands (=/command=) work with completion: type =/= then =TAB= to
see available commands, including your custom ones from =~/.pi/commands/=.

** üîß Tool Output

Tool output (file reads, command results) is collapsed by default to keep
the chat readable. Press =TAB= on a tool block to expand it. Code blocks
have full syntax highlighting.

** üíæ Sessions

Each project directory gets its own session automatically. To run multiple
sessions in the same directory, use =C-u M-x pi= to create a named session.

Branching (=C-c C-p b=) and resume (=C-c C-p r=) work as in the pi TUI.

* Configuration

Example configuration with =use-package=:

#+begin_src emacs-lisp
(use-package pi-coding-agent
  :ensure t
  :init (defalias 'pi 'pi-coding-agent)
  :custom
  (pi-coding-agent-input-window-height 10)      ; Height of input window
  (pi-coding-agent-tool-preview-lines 10)       ; Lines shown before collapsing tool output
  (pi-coding-agent-bash-preview-lines 5))       ; Lines shown for bash output
#+end_src

* Testing

** Running tests locally

Requires Docker for integration and GUI tests (Ollama runs in a container).

#+begin_src bash
# Unit tests only (fast, no Docker)
make check

# Integration tests (requires Docker)
make test-integration

# GUI tests (requires Docker)
make test-gui

# All tests
make test-all
#+end_src

** GUI tests with visible window

By default, GUI tests auto-detect whether to show a window or run headless.

#+begin_src bash
# With a display available, runs with visible window
./test/run-gui-tests.sh

# Force headless even with display available
./test/run-gui-tests.sh --headless
#+end_src

** CI setup

GitHub Actions runs on every push:
- =test-unit.yml= - Unit tests across Emacs 28.2 and 29.4
- =test-integration.yml= - Integration tests with Docker Ollama
- =test-gui.yml= - GUI tests with xvfb virtual framebuffer

Nightly builds test against multiple pi versions (0.30.2, latest, and main branch).

* Links

- [[https://danielnouri.org/notes/2025/12/30/an-emacs-mode-for-a-shitty-coding-agent/][Blog post]]: Background and motivation
- [[https://shittycodingagent.ai/][shittycodingagent.ai]]: pi coding agent home page

* License

GPL-3.0-or-later. See [[file:LICENSE][LICENSE]].
